# ============================================
# PixelPunk Docker é•œåƒæž„å»ºä¸ŽæŽ¨é€å·¥ä½œæµ
# ============================================
# åŠŸèƒ½ï¼š
#   - æ‰‹åŠ¨è§¦å‘æž„å»ºå’ŒæŽ¨é€ Docker é•œåƒåˆ° Docker Hub
#   - æ”¯æŒè‡ªå®šä¹‰ç‰ˆæœ¬å·ï¼ˆæ ¼å¼ï¼šv*.*.*ï¼‰
#   - å¤šæž¶æž„æž„å»ºï¼ˆlinux/amd64, linux/arm64ï¼‰
#   - è‡ªåŠ¨ç”Ÿæˆ latest æ ‡ç­¾
#
# å¿…éœ€çš„ Secretsï¼š
#   - DOCKER_USERNAME: Docker Hub ç”¨æˆ·å
#   - DOCKER_PASSWORD: Docker Hub å¯†ç æˆ–è®¿é—®ä»¤ç‰Œ
# ============================================

name: Build and Push Docker Image

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆæ ¼å¼ï¼šv1.2.3ï¼Œç•™ç©ºåˆ™åªæž„å»º latestï¼‰'
        required: false
        default: ''
        type: string
      push:
        description: 'æ˜¯å¦æŽ¨é€åˆ° Docker Hub'
        required: true
        default: true
        type: boolean

  # Tag æŽ¨é€è‡ªåŠ¨è§¦å‘ï¼ˆæ ¼å¼ï¼šv*.*.*ï¼‰
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/pixelpunk
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  build-and-push:
    name: Build & Push Multi-arch Image
    runs-on: ubuntu-latest

    # è®¾ç½®ç‰ˆæœ¬å·å˜é‡
    env:
      # ä¼˜å…ˆä½¿ç”¨ tag åç§°ï¼Œå…¶æ¬¡ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬å·
      VERSION: ${{ github.ref_type == 'tag' && github.ref_name || github.event.inputs.version || '' }}
      # tag è§¦å‘æ—¶å§‹ç»ˆæŽ¨é€ï¼Œæ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥å‚æ•°
      SHOULD_PUSH: ${{ github.ref_type == 'tag' || github.event.inputs.push == 'true' }}
    
    steps:
      # ========================================
      # 1. æ£€å‡ºä»£ç 
      # ========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # 2. éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ï¼ˆå¦‚æžœæä¾›ï¼‰
      # ========================================
      - name: Validate version format
        if: ${{ env.VERSION != '' }}
        run: |
          VERSION="${{ env.VERSION }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯: $VERSION"
            echo "   æ­£ç¡®æ ¼å¼: v1.2.3"
            exit 1
          fi
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡: $VERSION"

      # ========================================
      # 3. è®¾ç½® Docker å…ƒæ•°æ®ï¼ˆæ ‡ç­¾å’Œ labelsï¼‰
      # ========================================
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ env.VERSION }},enable=${{ env.VERSION != '' }}
          labels: |
            org.opencontainers.image.title=PixelPunk
            org.opencontainers.image.description=PixelPunk - æ™ºèƒ½å›¾ç‰‡ç®¡ç†ç³»ç»Ÿ
            org.opencontainers.image.vendor=PixelPunk
            org.opencontainers.image.version=${{ env.VERSION || 'latest' }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      # ========================================
      # 4. è®¾ç½® QEMUï¼ˆå¤šæž¶æž„æ¨¡æ‹Ÿï¼‰
      # ========================================
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ env.PLATFORMS }}

      # ========================================
      # 5. è®¾ç½® Docker Buildx
      # ========================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
            network=host

      # ========================================
      # 6. ç™»å½• Docker Hub
      # ========================================
      - name: Login to Docker Hub
        if: ${{ env.SHOULD_PUSH == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ========================================
      # 7. æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
      # ========================================
      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ env.PLATFORMS }}
          push: ${{ env.SHOULD_PUSH == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ env.VERSION || 'latest' }}

      # ========================================
      # 8. è¾“å‡ºæž„å»ºç»“æžœ
      # ========================================
      - name: Build Summary
        run: |
          echo "## ðŸ³ Docker é•œåƒæž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| å±žæ€§ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| é•œåƒåç§° | \`${{ env.DOCKER_IMAGE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬æ ‡ç­¾ | \`${{ env.VERSION || 'latest' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ”¯æŒæž¶æž„ | \`${{ env.PLATFORMS }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘æ–¹å¼ | \`${{ github.ref_type == 'tag' && 'Tag æŽ¨é€' || 'æ‰‹åŠ¨è§¦å‘' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ˜¯å¦æŽ¨é€ | \`${{ env.SHOULD_PUSH }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Git SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ env.SHOULD_PUSH }}" == "true" ]]; then
            echo "### ðŸš€ æ‹‰å–é•œåƒ" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.DOCKER_IMAGE }}:${{ env.VERSION || 'latest' }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

